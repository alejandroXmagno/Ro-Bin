# RViz2 Visualization Guide

## Quick Start

```bash
# Terminal 1: Start navigation
./run_hardware_navigation.sh --explore

# Terminal 2: Open RViz2
./view_hardware_nav.sh
```

## What You See

### Color-Coded Display

| Color | Element | Description |
|-------|---------|-------------|
| üî¥ **RED** | Original LiDAR | Raw `/scan` data from hardware |
| üü¢ **GREEN** | Filtered LiDAR | `/scan_filtered` with ignored angles removed |
| üü¢ **Green Line** | Global Plan | Long-term path from Nav2 planner |
| üü° **Yellow Line** | Local Plan | Short-term trajectory from controller |
| üó∫Ô∏è **Gray** | SLAM Map | Real-time generated map |
| üü¶ **Blue/Purple** | Local Costmap | Obstacle inflation zone |
| üéØ **Orange** | Goal Pose | Current navigation target |
| ü§ñ **White** | Robot Model | Your rover |
| üü© **Green Outline** | Footprint | Robot's physical boundary |

### LiDAR Visualization

**Original Scan (RED):**
- Shows ALL LiDAR readings
- May include robot parts or static obstacles
- 360¬∞ coverage at 10 Hz
- Topic: `/scan`

**Filtered Scan (GREEN):**
- Your recorded angles are REMOVED
- Used by navigation for obstacle detection
- Topic: `/scan_filtered`
- Missing green points = filtered angles

**What to look for:**
- Check filtered points align with real obstacles
- Verify removed angles don't include important obstacles
- Both scans should update smoothly at ~10 Hz

### Path Planning Visualization

**Global Plan (GREEN LINE):**
- Long-term path to goal
- Planned by NavFn planner
- Updated every few seconds
- Shows overall strategy
- Topic: `/plan`

**Local Plan (YELLOW LINE):**
- Short-term trajectory (1-2 seconds ahead)
- Planned by DWB controller
- Updated at 20 Hz
- Shows immediate movements
- Topic: `/local_plan`

**What to look for:**
- Global plan should avoid known obstacles
- Local plan should smoothly follow global plan
- Local plan should react to dynamic obstacles
- No jittery or oscillating paths

### Costmap Visualization

**Local Costmap (Blue/Purple overlay):**
- 10m x 10m around robot
- Shows obstacle inflation
- Darker = more dangerous
- Updates at 5 Hz
- Topic: `/local_costmap/costmap`

**Global Costmap (optional, disabled by default):**
- Full map-sized costmap
- Shows all known obstacles
- Topic: `/global_costmap/costmap`

**Color meaning:**
- **Dark purple/blue** = Lethal obstacle
- **Light blue** = Inflated obstacle (buffer zone)
- **White** = Free space
- **Gray** = Unknown space

### Map Display

**SLAM Map:**
- Real-time generated by SLAM Toolbox
- Black = walls/obstacles
- White = free space  
- Gray = unexplored
- Updates as robot explores
- Topic: `/map`

### Robot Display

**Robot Model:**
- Shows rover's URDF model
- Positioned via TF transforms
- Includes LiDAR sensor
- Topic: `/robot_description`

**Footprint:**
- Green polygon outline
- Shows robot's physical boundary
- Used for collision checking
- Topic: `/local_costmap/published_footprint`

## Interactive Tools

### 2D Pose Estimate
**Use:** Correct robot's localization
**When:** 
- Robot's position on map is wrong
- After moving robot manually
- SLAM lost track

**How to use:**
1. Click "2D Pose Estimate" button
2. Click on map where robot actually is
3. Drag to set robot's orientation
4. Release to update

### 2D Goal Pose
**Use:** Send manual navigation goal
**When:**
- Testing navigation
- Manual control needed
- Overriding autonomous exploration

**How to use:**
1. Click "2D Goal Pose" button
2. Click on map where you want robot to go
3. Drag to set desired final orientation
4. Release to send goal

**Tips:**
- Don't set goals in walls or unknown areas
- Try goals 2-3 meters away first
- Watch global plan appear after setting goal

### Measure Tool
**Use:** Measure distances on map

**How to use:**
1. Click "Measure" button
2. Click start point
3. Click end point
4. Distance shown in meters

### Select Tool
**Use:** Inspect specific elements
- Click on elements to see details
- View topic data
- Check TF frames

## Display Panels

### Left Panel: Displays
- Toggle visibility of each element
- Expand to see properties
- Adjust colors, sizes, transparency
- Enable/disable specific topics

**Quick toggles:**
- Uncheck "LaserScan (Original)" to hide red points
- Uncheck "LocalCostmap" to see map better
- Uncheck "TF" to reduce visual clutter

### Bottom Panel: Views
Switch between view modes:
- **TopDownOrtho** (default) - Bird's eye view, good for navigation
- **Orbit** - 3D rotating view
- **FPS** - First person view

### Right Panel: Tool Properties
- Adjust tool settings
- See current measurements
- Configure pose estimate covariance

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| **Mouse wheel** | Zoom in/out |
| **Middle click + drag** | Pan view |
| **Shift + mouse** | Rotate view (Orbit mode) |
| **R** | Reset view to default |
| **G** | Toggle grid |
| **F** | Focus on selected object |

## Troubleshooting

### No LiDAR Points Visible

**Check:**
```bash
# Verify scan topic is publishing
ros2 topic hz /scan
ros2 topic hz /scan_filtered

# Should show ~10 Hz for both
```

**Fix:**
- Ensure robot driver is running
- Check filtered LiDAR scanner is running
- Verify "LaserScan" displays are enabled in RViz

### No Map Showing

**Check:**
```bash
# Verify map is being published
ros2 topic hz /map

# Should show updates (1-2 Hz)
```

**Fix:**
- Ensure SLAM is running
- Drive robot around to build map
- Check "Map" display is enabled

### No Path Lines Visible

**Check:**
```bash
# Verify navigation is active
ros2 node list | grep -E "controller|planner|bt_navigator"

# Check if goal is set
ros2 topic echo /goal_pose --once
```

**Fix:**
- Send a navigation goal with "2D Goal Pose"
- Ensure navigation stack is running
- Check "Global Plan" and "Local Plan" are enabled

### Robot Model Not Showing

**Check:**
```bash
# Verify robot description is published
ros2 topic echo /robot_description --once

# Verify TF is working
ros2 run tf2_tools view_frames
```

**Fix:**
- Ensure robot driver published URDF
- Check TF display is enabled
- Verify base_link frame exists

### Fixed Frame Error

**Symptom:** "Fixed Frame [map] does not exist"

**Fix:**
1. Change Fixed Frame to `odom` initially
2. Wait for SLAM to create map frame
3. Then switch back to `map`

**In RViz:**
- Global Options ‚Üí Fixed Frame ‚Üí Select `odom` or `base_link`

### Costmap Not Updating

**Check:**
```bash
# Verify costmap topics
ros2 topic hz /local_costmap/costmap
ros2 topic hz /global_costmap/costmap
```

**Fix:**
- Ensure Nav2 is running
- Check obstacle sources are publishing
- Verify filtered LiDAR is active

## Performance Tips

### Reduce Lag

**Disable heavy displays:**
- Global Costmap (already off by default)
- TF axes (uncheck "Show Axes")
- Marker arrays

**Reduce quality:**
- Decrease "Decay Time" on LaserScans to 0
- Reduce "Size (Pixels)" for laser scans
- Lower costmap alpha (transparency)

### Better Clarity

**For LiDAR analysis:**
- Disable costmap overlays temporarily
- Increase laser scan point size
- Use contrasting colors

**For path planning:**
- Disable one of the laser scans
- Enable global costmap briefly
- Focus on plan lines

### Save Custom Layout

1. Arrange displays as you like
2. File ‚Üí Save Config As...
3. Save to custom location
4. Load later with: `rviz2 -d your_config.rviz`

## Advanced Features

### Multiple RViz Windows

Run multiple RViz instances:
```bash
# Terminal 1: Main view
./view_hardware_nav.sh

# Terminal 2: Costmap focus
rviz2 -d src/rover_exploration/config/hardware_nav_visualization.rviz
```

### Record Video

Use ROS2 bag to record display:
```bash
ros2 bag record /scan /scan_filtered /map /plan /local_plan /tf /tf_static
```

Later replay and record screen:
```bash
ros2 bag play your_bag
# Open RViz and use screen recording software
```

### Custom Views

Save camera positions:
1. Position view as desired
2. Views panel ‚Üí Current ‚Üí Right-click ‚Üí "Save"
3. Name the view
4. Later: Views ‚Üí Saved ‚Üí Select view

## Topic Reference

| Topic | Type | Rate | Description |
|-------|------|------|-------------|
| `/scan` | LaserScan | 10 Hz | Original LiDAR |
| `/scan_filtered` | LaserScan | 10 Hz | Filtered LiDAR |
| `/map` | OccupancyGrid | 1-2 Hz | SLAM map |
| `/plan` | Path | Variable | Global plan |
| `/local_plan` | Path | 20 Hz | Local plan |
| `/local_costmap/costmap` | OccupancyGrid | 5 Hz | Local obstacles |
| `/global_costmap/costmap` | OccupancyGrid | 1 Hz | Global obstacles |
| `/goal_pose` | PoseStamped | On-demand | Navigation goal |
| `/robot_description` | String | On-startup | URDF model |
| `/tf` | TFMessage | 100+ Hz | Transform tree |

## Integration with Navigation

### Watch Robot Navigate

1. **Set a goal** with "2D Goal Pose"
2. **Watch global plan** appear (green line)
3. **Watch local plan** adjust (yellow line)
4. **See costmap** inflate around obstacles
5. **Monitor LiDAR** detect obstacles in real-time
6. **Watch robot** follow path smoothly

### Debugging Navigation Issues

**Robot not moving:**
- Check if goal pose is set (orange marker visible)
- Verify plan line exists
- Check if costmap shows free path

**Robot avoiding clear space:**
- Check costmap inflation (too aggressive?)
- Verify filtered LiDAR isn't removing needed data
- Check obstacle distance parameters

**Jittery movement:**
- Watch local plan oscillate
- Check if controller fighting itself
- See NAVIGATION_FIXES.md

**Robot getting stuck:**
- Watch if plan keeps recalculating
- Check if stuck in local minimum
- Verify recovery behaviors activate

## Best Practices

1. **Start with overview** - Use TopDownOrtho view
2. **Monitor both scans** - Compare red vs green points
3. **Watch plans converge** - Global and local should align
4. **Check costmap inflation** - Adequate but not excessive
5. **Verify map quality** - Clean SLAM data
6. **Test manual goals** - Before autonomous exploration
7. **Save configs** - Save your preferred view settings
8. **Use measure tool** - Verify distances and clearances

## Files Created

- `hardware_nav_visualization.rviz` - RViz configuration
- `view_hardware_navigation.launch.py` - Launch file
- `view_hardware_nav.sh` - Convenience script
- This guide: `RVIZ_VISUALIZATION_GUIDE.md`

---

**Enjoy visualizing your robot's navigation! üé®ü§ñ**

